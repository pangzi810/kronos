# 要件定義書

## はじめに
製品開発工数管理ツールにおいて、現在アクティブな開発者の一覧を取得するAPIエンドポイント `/api/users/active/developers` を提供する機能を実装する。このAPIは、PMOやシステム管理者が現在利用可能でプロジェクトに割り当て可能な開発者の情報を効率的に取得することを可能にし、リソース管理と割り当て決定を支援する。

## プロジェクト概要
有効な開発者一覧を返却するAPIを作成 /api/users/active/developers

## 要件

### 要件1: APIエンドポイント提供
**ユーザーストーリー:** PMOとして、現在アクティブな開発者の一覧を取得するために、専用のAPIエンドポイントを利用したい。これによりリソース管理と新規プロジェクトへの開発者アサインを効率的に行える。

#### 受入基準
1. **WHEN** クライアントがGETリクエストを `/api/users/active/developers` に送信する **THEN** システムは有効な開発者一覧をJSON形式でレスポンスする **SHALL**
2. **WHEN** APIが呼び出される **THEN** システムは開発者ロールを持つユーザーのみをフィルタリングして返却する **SHALL**
3. **WHEN** レスポンスを生成する **THEN** システムは各開発者の基本情報（ID、名前、メールアドレス）を含む **SHALL**
4. **WHEN** APIが正常に実行される **THEN** システムはHTTPステータス200とContent-Type: application/jsonでレスポンスする **SHALL**

### 要件2: アクティブ開発者の定義と判定
**ユーザーストーリー:** システム管理者として、「アクティブな開発者」の定義を明確にし、適切な開発者のみが結果に含まれるようにしたい。これにより正確なリソース情報を提供できる。

#### 受入基準
1. **WHEN** システムがアクティブ開発者を判定する **THEN** ユーザーのisActiveフラグがtrueである **SHALL**
2. **WHEN** システムがアクティブ開発者を判定する **AND** ユーザーが開発者ロールを持つ **THEN** そのユーザーを候補に含める **SHALL**
3. **IF** ユーザーがisActive=falseまたは削除済み **THEN** システムはそのユーザーを結果から除外する **SHALL**
4. **IF** ユーザーがPMOロールのみを持つ **THEN** システムはそのユーザーを結果から除外する **SHALL**

### 要件3: 認証とセキュリティ
**ユーザーストーリー:** セキュリティ管理者として、このAPIへのアクセスが適切に認証・認可されたユーザーのみに制限されるようにしたい。これによりシステムの安全性を保つ。

#### 受入基準
1. **WHEN** 認証されていないユーザーがAPIを呼び出す **THEN** システムはHTTPステータス401 (Unauthorized)を返却する **SHALL**
2. **WHEN** 有効なJWTトークンを持つユーザーがAPIを呼び出す **THEN** システムはリクエストを処理する **SHALL**
3. **WHEN** 無効または期限切れのJWTトークンでAPIを呼び出す **THEN** システムはHTTPステータス401 (Unauthorized)を返却する **SHALL**
4. **IF** ユーザーが適切な権限を持たない **THEN** システムはHTTPステータス403 (Forbidden)を返却する **SHALL**

### 要件4: データ形式とレスポンス構造
**ユーザーストーリー:** API利用者として、一貫性のある構造化されたデータ形式で開発者情報を受け取りたい。これにより他システムとの連携やフロントエンドでの表示が容易になる。

#### 受入基準
1. **WHEN** APIがレスポンスを返す **THEN** レスポンスボディは有効なJSON形式である **SHALL**
2. **WHEN** レスポンスを生成する **THEN** システムは以下の構造を使用する **SHALL**:
   ```json
   {
     "developers": [
       {
         "id": "ユーザーID",
         "name": "氏名",
         "email": "メールアドレス"
       }
     ],
     "totalCount": "開発者総数"
   }
   ```
3. **WHEN** データが存在しない **THEN** システムは空の配列と totalCount: 0 を返却する **SHALL**
4. **WHEN** レスポンスを生成する **THEN** システムは機密情報（パスワード、JWT秘密鍵）を含めない **SHALL**

### 要件5: エラーハンドリングと例外処理
**ユーザーストーリー:** システム運用者として、APIで発生するエラーが適切に処理され、明確なエラーメッセージが返されるようにしたい。これによりトラブルシューティングが効率化される。

#### 受入基準
1. **WHEN** データベース接続エラーが発生する **THEN** システムはHTTPステータス500とエラーメッセージを返却する **SHALL**
2. **WHEN** 予期しない例外が発生する **THEN** システムは詳細な技術情報を隠したエラーレスポンスを返却する **SHALL**
3. **WHEN** エラーが発生する **THEN** システムは以下の形式でエラー情報を返却する **SHALL**:
   ```json
   {
     "error": {
       "code": "エラーコード",
       "message": "ユーザー向けメッセージ",
       "timestamp": "エラー発生時刻"
     }
   }
   ```
4. **WHEN** システムエラーが発生する **THEN** ログに詳細なエラー情報を記録する **SHALL**

### 要件6: パフォーマンスと効率性
**ユーザーストーリー:** システム利用者として、APIレスポンスが迅速に返されることで、ユーザーエクスペリエンスを向上させたい。

#### 受入基準
1. **WHEN** 通常の負荷条件下でAPIが呼び出される **THEN** システムは2秒以内にレスポンスを返却する **SHALL**
2. **WHEN** データベースクエリを実行する **THEN** システムは必要最小限のデータのみを取得する **SHALL**
3. **WHEN** 複数の同時リクエストを処理する **THEN** システムはデータベースのコネクションプールを効率的に使用する **SHALL**
4. **IF** 開発者数が100人を超える **THEN** システムはページネーション機能の追加を検討する **SHALL**

### 要件7: 運用・監視対応
**ユーザーストーリー:** システム運用者として、APIの使用状況とパフォーマンスを監視し、必要に応じてメンテナンスを実施したい。

#### 受入基準
1. **WHEN** APIが呼び出される **THEN** システムはアクセスログを記録する **SHALL**
2. **WHEN** APIが正常に実行される **THEN** レスポンス時間をメトリクスとして記録する **SHALL**
3. **WHEN** エラーが発生する **THEN** エラーの種類と頻度をログに記録する **SHALL**
4. **WHILE** APIが運用中 **THE SYSTEM SHALL** Spring Boot Actuatorエンドポイントでヘルスチェック情報を提供する

---
**ステータス**: 要件生成完了
**次のステップ**: `/sdd:spec-design active-developers-api` を実行して設計フェーズに進む