# Requirements Document

## Introduction

フロントエンドから受信したOkta JWTトークンを検証し、トークンに含まれるユーザー情報をアプリケーションのローカルデータベースに反映するJust-In-Time (JIT) ユーザープロビジョニング機能を実装します。この機能により、Oktaで認証されたユーザーが初回アクセス時に自動的にアプリケーション内でユーザーアカウントが作成され、既存ユーザーについては最新の情報に更新されることで、シームレスなユーザー体験を提供します。

## Requirements

### Requirement 1: JWT検証による初回ユーザー登録

**User Story:** システム管理者として、フロントエンドから受信したOkta JWTトークンを検証し、初回アクセス時に自動的にアプリケーション内でユーザーアカウントが作成されるようにしたい。これにより、手動でのユーザー登録作業を削減し、ユーザーがすぐにアプリケーションを利用開始できるようになる。

#### Acceptance Criteria

1. **WHEN** フロントエンドからOkta JWTトークンを含むAPIリクエストを受信し、トークン内のemailクレームと一致するユーザーが存在しない場合 **THEN** システムは新しいユーザーレコードを作成しなければならない

2. **WHEN** 新規ユーザーを作成する場合 **THEN** システムはOktaのJWTトークンから以下の情報を抽出してユーザーレコードに保存しなければならない：
   - okta_user_id (sub claim)
   - username (preferred_username claim)
   - email (email claim)  
   - full_name (name claim)

3. **WHEN** 新規ユーザーを作成する場合 **THEN** システムはユーザーステータスを'ACTIVE'に設定し、created_atとupdated_atに現在時刻を設定しなければならない

4. **IF** 新規ユーザー作成が成功した場合 **THEN** システムは作成されたユーザー情報をログに記録しなければならない

5. **WHEN** 同じemailアドレスを持つユーザーが既に存在する場合 **THEN** システムはメールアドレスをキーとして既存ユーザーとOktaユーザーを統合し、okta_user_idフィールドを更新しなければならない


### Requirement 2: JWT検証による既存ユーザー情報の更新

**User Story:** システム管理者として、フロントエンドから受信したOkta JWTトークンを検証し、既存ユーザーの情報を最新の状態に更新したい。これにより、ユーザー情報の整合性を保ち、組織変更などの情報が自動的に反映される。

#### Acceptance Criteria

1. **WHEN** フロントエンドからOkta JWTトークンを含むAPIリクエストを受信し、トークン内のemailクレームと一致するユーザーが既存のusersテーブルに存在する場合 **THEN** システムは既存ユーザー情報を更新しなければならない

2. **WHEN** 既存ユーザーを更新する場合 **THEN** システムは以下の情報をOktaトークンから取得して更新しなければならない：
   - okta_user_id (sub claim)
   - username (preferred_username claim)
   - email (email claim)
   - full_name (name claim)
   - last_login_at (現在時刻)

3. **WHEN** ユーザー情報を更新する場合 **THEN** システムはupdated_atフィールドを現在時刻で更新しなければならない

4. **IF** ユーザー情報に変更があった場合 **THEN** システムは更新内容をログに記録しなければならない

5. **WHEN** 既存ユーザーがINACTIVEまたはSUSPENDEDステータスの場合 **THEN** システムは認証成功後に自動的にステータスをACTIVEに更新しなければならない


### Requirement 3: JWTトークン処理とデータ抽出

**User Story:** 開発者として、フロントエンドから受信したOkta JWTアクセストークンを安全に検証し、ユーザー情報を抽出したい。これにより、セキュアで信頼性の高いユーザー管理機能を実現する。

#### Acceptance Criteria

1. **WHEN** フロントエンドからAuthorizationヘッダーまたはリクエストボディでOktaアクセストークンを受信した場合 **THEN** システムはトークンの署名と有効期限を検証しなければならない

2. **WHEN** JWTトークンを処理する場合 **THEN** システムは以下のクレームを抽出しなければならない：
   - sub (Oktaユーザー識別子)
   - email (メールアドレス)
   - name (フルネーム)
   - preferred_username (ユーザー名)
   - iss (発行者)
   - exp (有効期限)

3. **IF** 必須クレーム（sub、email）が存在しない場合 **THEN** システムは認証エラーとして処理し、ユーザー登録・更新を実行してはならない

4. **WHEN** トークンのissuerが設定されたOktaドメインと一致しない場合 **THEN** システムはセキュリティエラーとして処理しなければならない

5. **WHEN** メールアドレスの形式が無効な場合 **THEN** システムはバリデーションエラーとして処理し、適切なエラーメッセージを返さなければならない

6. **WHEN** トークンの有効期限が切れている場合 **THEN** システムは401 Unauthorizedエラーを返さなければならない

### Requirement 4: エラーハンドリングとリカバリー

**User Story:** システム管理者として、JWT検証とユーザー登録・更新処理で発生する可能性のあるエラーが適切にハンドリングされ、システムの安定性が確保されるようにしたい。これにより、一時的な障害に対する耐性を持ち、データの整合性を維持する。

#### Acceptance Criteria

1. **WHEN** データベース接続エラーが発生した場合 **THEN** システムはユーザー登録・更新を停止し、適切なエラーログを記録しなければならない

2. **WHEN** ユーザー作成または更新処理でSQL例外が発生した場合 **THEN** システムはトランザクションをロールバックし、エラー詳細をログに記録しなければならない

3. **WHEN** ユーザーテーブルを設計する場合 **THEN** システムはemail列とdeleted_at列の組み合わせに対してユニーク制約を設定し、同一メールアドレスを持つアクティブユーザーが複数存在することを防がなければならない

4. **WHEN** 不正なJWTトークンを受信した場合 **THEN** システムは認証を拒否し、セキュリティログに記録しなければならない

5. **WHEN** JWT検証が連続して失敗する場合 **THEN** システムは不正アクセスの可能性としてセキュリティログに記録し、管理者にアラートを送信しなければならない

### Requirement 5: APIエンドポイントとレスポンス

**User Story:** フロントエンド開発者として、認証後のユーザー情報取得エンドポイントが提供されるようにしたい。これにより、現在のユーザー情報をフロントエンドで利用できる。

#### Acceptance Criteria

1. **WHEN** 認証されたユーザーが `/api/auth/me` エンドポイントにアクセスした場合 **THEN** システムは現在のユーザー情報を返さなければならない

2. **WHEN** ユーザー情報取得が成功した場合 **THEN** システムは以下の情報を含むレスポンスを返さなければならない：
   - ユーザーID
   - Oktaユーザー ID
   - ユーザー名
   - メールアドレス
   - フルネーム
   - 最終更新日時
   - 最終ログイン日時

3. **IF** ユーザー情報取得でエラーが発生した場合 **THEN** システムは適切なHTTPステータスコード（400, 401, 403, 500）とエラーメッセージを返さなければならない

### Requirement 6: ログと監査

**User Story:** セキュリティ管理者として、JWT検証とユーザー登録・更新アクティビティが適切にログに記録され、監査要件を満たすようにしたい。これにより、セキュリティインシデントの調査とコンプライアンス要件の充足を実現する。

#### Acceptance Criteria

1. **WHEN** 新規ユーザーが作成された場合 **THEN** システムは以下の情報を監査ログに記録しなければならない：
   - タイムスタンプ
   - OktaユーザーID
   - 作成されたユーザーID
   - メールアドレス
   - IPアドレス

2. **WHEN** 既存ユーザーが更新された場合 **THEN** システムは変更された項目と変更前後の値を監査ログに記録しなければならない

3. **WHEN** JWT検証またはユーザー登録・更新でエラーが発生した場合 **THEN** システムはエラー詳細とコンテキスト情報をエラーログに記録しなければならない

4. **WHEN** セキュリティ関連のイベント（不正トークン、重複ユーザーなど）が発生した場合 **THEN** システムは高優先度のセキュリティログに記録しなければならない

5. **WHEN** 監査ログが90日を経過した場合 **THEN** システムは設定に基づいてアーカイブまたは削除を実行しなければならない


### Requirement 7: 設定と管理

**User Story:** システム管理者として、JWT検証とユーザー登録・更新機能の動作を環境に応じて柔軟に設定し、管理できるようにしたい。これにより、組織の要件に応じたカスタマイズが可能になる。

#### Acceptance Criteria

1. **WHERE** アプリケーション設定ファイルまたは環境変数において **システムは以下の設定項目を提供しなければならない**：
   - Okta issuer URL
   - JWT検証の公開鍵エンドポイント
   - トークン有効期限の許容誤差
   - クレームマッピング設定

2. **IF** 無効な設定値が指定された場合 **THEN** システムは起動時にバリデーションエラーを表示し、デフォルト値を使用しなければならない