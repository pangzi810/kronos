# Requirements Document

## はじめに
本機能は、上司が自分の部下一覧を確認し、選択した部下に対してプロジェクトを効率的にアサインできる機能を提供します。既存のアサインメント画面（AssignmentsView）と統一されたUIデザインを採用し、一括アサインや個別アサインの両方をサポートします。これにより、プロジェクトリソース管理の効率化と、チーム管理者の作業負荷軽減を実現します。

## 要件

### 要件1: 部下一覧表示機能
**ユーザーストーリー:** 上司として、現在有効な部下の一覧を確認したい。そうすることで、誰にプロジェクトをアサインすべきか判断できる。

#### 受け入れ基準
1. WHEN ユーザーが部下プロジェクトアサイン画面にアクセスした時 THEN システムは現在ログインしているユーザーの有効な部下一覧を表示しなければならない
2. IF ユーザーに有効な部下が存在しない場合 THEN システムは「部下が登録されていません」というメッセージを表示しなければならない
3. WHEN 部下一覧が表示される時 THEN システムは各部下の氏名、メールアドレス、現在のプロジェクト数を表示しなければならない
4. WHILE 部下一覧を読み込んでいる間 THE SYSTEM SHALL ローディングインジケーターを表示しなければならない
5. WHEN 部下一覧の取得でエラーが発生した時 THEN システムはエラーメッセージをトースト通知で表示しなければならない
6. WHERE 部下が削除済み（論理削除）または無効化されている場合 THE SYSTEM SHALL その部下を一覧に表示してはならない
7. WHEN 部下が20人以上存在する時 THEN システムはページネーション機能を提供しなければならない
8. IF SupervisorRelationshipのis_activeがfalseの場合 THEN システムはその関係の部下を一覧に含めてはならない
9. WHERE Userのis_deletedがtrueまたはis_activeがfalseの場合 THE SYSTEM SHALL その部下を一覧から除外しなければならない

### 要件2: 部下選択機能
**ユーザーストーリー:** 上司として、一覧から複数の部下を選択したい。そうすることで、複数人に同時にプロジェクトをアサインできる。

#### 受け入れ基準
1. WHEN ユーザーが部下リストの行をクリックした時 THEN システムはその部下を選択状態にしなければならない
2. WHEN ユーザーが全選択チェックボックスをクリックした時 THEN システムは現在表示されているすべての部下を選択しなければならない
3. IF 部下がすでにプロジェクトの最大数（設定値）に達している場合 THEN システムはその部下の行を警告色で表示しなければならない
4. WHEN 部下が選択されている時 THEN システムは選択された部下の数を画面上部に表示しなければならない
5. WHEN ユーザーが選択解除ボタンをクリックした時 THEN システムはすべての選択を解除しなければならない
6. WHERE 部下が無効化されている場合 THE SYSTEM SHALL その部下を選択不可能な状態で表示しなければならない

### 要件3: プロジェクト選択・アサイン機能
**ユーザーストーリー:** 上司として、選択した部下にプロジェクトをアサインしたい。そうすることで、チームメンバーの配置を効率的に管理できる。

#### 受け入れ基準
1. WHEN ユーザーが「プロジェクトアサイン」ボタンをクリックした時 AND 部下が選択されている場合 THEN システムはプロジェクト選択ダイアログを表示しなければならない
2. IF 部下が選択されていない場合 THEN システムは「部下を選択してください」という警告メッセージを表示しなければならない
3. WHEN プロジェクト選択ダイアログが表示される時 THEN システムはアクティブなプロジェクトのみをリスト表示しなければならない
4. WHEN ユーザーがプロジェクトを選択してアサインボタンをクリックした時 THEN システムは選択された全部下に対してプロジェクトアサインを実行しなければならない
5. IF 部下がすでに同じプロジェクトにアサインされている場合 THEN システムはその部下をスキップし、警告メッセージを表示しなければならない
6. WHEN アサイン処理が成功した時 THEN システムは成功メッセージをトースト通知で表示し、部下一覧を更新しなければならない
7. WHERE アサイン処理中にエラーが発生した場合 THE SYSTEM SHALL トランザクションをロールバックし、エラーメッセージを表示しなければならない
8. WHEN プロジェクトアサインが実行される時 THEN システムは監査ログにアサイン情報を記録しなければならない

### 要件4: UI統一性
**ユーザーストーリー:** ユーザーとして、既存のアサインメント画面と同じUIで操作したい。そうすることで、学習コストなく新機能を使用できる。

#### 受け入れ基準
1. WHEN 部下プロジェクトアサイン画面が表示される時 THEN システムはAssignmentsViewと同じレイアウト構造を使用しなければならない
2. WHERE テーブル表示を行う場合 THE SYSTEM SHALL Vuetifyのv-data-tableコンポーネントを使用しなければならない
3. WHEN ボタンやフォーム要素が表示される時 THEN システムは既存のUIコンポーネントライブラリのスタイルを適用しなければならない
4. IF ダークモードが有効な場合 THEN システムは適切なダークモードカラースキームを適用しなければならない
5. WHEN レスポンシブ表示が必要な時 THEN システムはモバイル、タブレット、デスクトップの各画面サイズに対応しなければならない

### 要件5: 権限管理
**ユーザーストーリー:** システム管理者として、適切な権限を持つユーザーのみが部下へのプロジェクトアサインを実行できるようにしたい。そうすることで、不正なアサインを防げる。

#### 受け入れ基準
1. IF ユーザーが部下を持たない場合 THEN システムは部下プロジェクトアサイン機能へのアクセスを拒否しなければならない
2. WHEN 非上司ユーザーが部下プロジェクトアサインAPIを呼び出した時 THEN システムは403 Forbiddenエラーを返さなければならない
3. WHERE ユーザーがPMOまたはADMINロールを持つ場合 THE SYSTEM SHALL すべての開発者へのプロジェクトアサインを許可しなければならない
4. WHEN ユーザーが他の上司の部下にアサインしようとした時 THEN システムは権限エラーを表示しなければならない
5. IF JWTトークンが無効または期限切れの場合 THEN システムは401 Unauthorizedエラーを返し、ログイン画面にリダイレクトしなければならない

### 要件6: データ整合性
**ユーザーストーリー:** システム管理者として、プロジェクトアサインのデータ整合性を保ちたい。そうすることで、システムの信頼性を確保できる。

#### 受け入れ基準
1. WHEN 複数の部下に同時にアサインする時 THEN システムはトランザクション内ですべての処理を実行しなければならない
2. IF アサイン中に一つでも失敗が発生した場合 THEN システムはすべてのアサインをロールバックしなければならない
3. WHEN プロジェクトアサインが実行される時 THEN システムはproject_assignmentsテーブルにレコードを作成しなければならない
4. WHERE 既存のアサインが存在する場合 THE SYSTEM SHALL 重複を防ぐためにユニーク制約違反エラーを処理しなければならない
5. WHEN アサインが成功した時 THEN システムはDomainEventEntityにイベントを記録しなければならない

### 要件7: パフォーマンス要件
**ユーザーストーリー:** ユーザーとして、大量の部下がいても快適に操作したい。そうすることで、効率的に作業を進められる。

#### 受け入れ基準
1. WHEN 部下一覧を取得する時 THEN システムは3秒以内にレスポンスを返さなければならない
2. WHERE 部下が20人以上存在する場合 THE SYSTEM SHALL ページネーションを使用して1ページあたり20件表示しなければならない
3. WHEN 検索機能を使用する時 THEN システムはデバウンス処理（500ms）を適用しなければならない
4. IF 複数の部下に同時アサインする場合 THEN システムはバッチ処理を使用して効率的に実行しなければならない
5. WHILE データを読み込んでいる間 THE SYSTEM SHALL スケルトンローダーまたはプログレスバーを表示しなければならない

### 要件8: 監査とログ記録
**ユーザーストーリー:** コンプライアンス担当者として、誰がいつ誰にプロジェクトをアサインしたか追跡したい。そうすることで、監査要件を満たせる。

#### 受け入れ基準
1. WHEN プロジェクトアサインが実行される時 THEN システムは実行者ID、対象部下ID、プロジェクトID、タイムスタンプを記録しなければならない
2. WHERE アサインが失敗した場合 THE SYSTEM SHALL エラーログに詳細な失敗理由を記録しなければならない
3. WHEN 監査ログが記録される時 THEN システムはAuditLoggingAspectを使用してAOP経由で記録しなければならない
4. IF バッチアサインが実行された場合 THEN システムは各アサインを個別の監査レコードとして記録しなければならない
5. WHEN セキュリティ関連のエラーが発生した時 THEN システムは試行されたアクションと拒否理由をセキュリティログに記録しなければならない