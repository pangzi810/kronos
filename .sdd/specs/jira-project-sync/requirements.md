# Requirements Document

## Introduction
JIRAのAPIを使用して外部のJIRAシステムからプロジェクト情報を自動的に取得・同期する機能。複数のJQLクエリを事前に登録し、定期的（1時間ごと）にJIRAから最新のプロジェクト情報を取得して、システム内のプロジェクトデータを更新する。認証情報はセキュリティを重視し、AWS Secrets Managerに保管し、Kubernetes Secretを経由してアクセスすることで、機密情報の安全な管理を実現する。これにより、JIRAで管理されているプロジェクト情報と開発工数管理ツールのプロジェクト情報の一貫性を保ち、手動での二重管理を排除する。

## Requirements

### Requirement 1: JIRA API接続設定
**User Story:** 管理者として、JIRAサーバーへの接続情報を設定したい。これにより、システムがJIRAからプロジェクト情報を取得できるようになる。

#### Acceptance Criteria
1. WHEN 管理者がJIRA接続設定画面にアクセスする THEN システムはJIRAサーバーURLの入力フォームを表示する
2. WHEN 管理者が有効なJIRA URL情報を入力して保存する THEN システムは接続情報（URL）をデータベースに保存する
3. WHEN システムがJIRA認証情報を必要とする THEN 環境変数から認証情報（APIトークン、ユーザー名）を取得する
4. WHEN 管理者が接続テストボタンをクリックする THEN システムは環境変数から認証情報を取得し、JIRA APIへの接続を試行して成功/失敗の結果を表示する
5. IF JIRA接続が失敗した場合 THEN システムは詳細なエラーメッセージ（ネットワークエラー、認証エラー、権限不足など）を表示する
6. WHERE 接続情報が表示される場合 THE SYSTEM SHALL URLのみを表示し、実際の認証情報は表示しない
7. WHEN 管理者が接続情報を更新する THEN システムは変更履歴を監査ログに記録する

### Requirement 2: JQLクエリ管理
**User Story:** 管理者として、プロジェクト情報を取得するためのJQLクエリを複数登録・管理したい。これにより、異なる条件のプロジェクトを柔軟に同期対象にできる。

#### Acceptance Criteria
1. WHEN 管理者がJQLクエリ管理画面にアクセスする THEN システムは登録済みJQLクエリの一覧を表示する
2. WHEN 管理者が新規JQLクエリ登録ボタンをクリックする THEN システムはクエリ名、JQL文、有効/無効フラグの入力フォームを表示する
3. WHEN 管理者がJQLクエリを入力して検証ボタンをクリックする THEN システムはJIRA APIを使用してクエリの妥当性を検証し、該当プロジェクト数を表示する
4. IF JQLクエリが不正な場合 THEN システムはJIRAから返されたエラーメッセージを表示する
5. WHEN 管理者が有効なJQLクエリを保存する THEN システムはクエリをデータベースに保存し、次回の同期スケジュールに反映する
6. WHEN 管理者が既存のJQLクエリを編集する THEN システムは変更前の値を履歴として保存する
7. WHEN 管理者がJQLクエリを削除する THEN システムは論理削除を行い、削除日時と削除者を記録する
8. WHERE 複数のJQLクエリが登録されている場合 THE SYSTEM SHALL 各クエリの実行優先順位を設定可能にする

### Requirement 3: 自動同期スケジューリング
**User Story:** システム管理者として、JIRAプロジェクト情報を1時間ごとに自動的に同期したい。これにより、手動操作なしで最新情報を維持できる。

#### Acceptance Criteria
1. WHEN システムが起動する THEN 1時間ごとの同期スケジュールを自動的に開始する
2. WHEN 同期スケジュール時刻になる THEN システムはすべての有効なJQLクエリを順次実行する
3. WHILE 同期処理が実行中 THE SYSTEM SHALL 同期ステータスを「実行中」として表示し、他の同期処理の開始を防ぐ
4. IF 前回の同期処理がまだ実行中の場合 THEN システムは新しい同期処理をスキップし、警告ログを記録する
5. WHEN 同期処理が完了する THEN システムは同期結果（成功/失敗、処理件数、エラー詳細）をログに記録する
6. IF 同期処理が3回連続で失敗した場合 THEN システムは管理者にメール通知を送信する
7. WHERE 同期スケジュールが設定されている場合 THE SYSTEM SHALL 次回実行予定時刻を管理画面に表示する

### Requirement 4: 手動同期実行
**User Story:** 管理者として、必要に応じて手動でJIRA同期を実行したい。これにより、緊急の更新を即座に反映できる。

#### Acceptance Criteria
1. WHEN 管理者が同期管理画面で手動同期ボタンをクリックする THEN システムは同期確認ダイアログを表示し、JIRAのissue_keyを基準にしてプロジェクトをマッピングする
2. WHEN 管理者が同期実行を確認する THEN システムは即座に同期処理を開始する
3. WHILE 手動同期が実行中 THE SYSTEM SHALL リアルタイムの進捗状況（処理中のクエリ、処理済み/総プロジェクト数）を表示する
4. IF 手動同期中にエラーが発生した場合 THEN システムはエラー内容を画面に表示し、処理を継続するか中止するかを選択可能にする
5. WHEN 手動同期が完了する THEN システムは同期結果サマリー（新規作成、更新、エラー件数）を表示する
6. WHERE 手動同期が実行される場合 THE SYSTEM SHALL 自動同期スケジュールをリセットし、次回は1時間後に実行する

### Requirement 5: プロジェクトフィールドマッピング
**User Story:** 管理者として、JIRAプロジェクトフィールドとローカルプロジェクトフィールドのマッピングを設定したい。これにより、異なるフィールド構造でも適切にデータを同期できる。

#### Acceptance Criteria
1. WHEN 管理者がフィールドマッピング設定画面にアクセスする THEN システムはJIRAフィールドをJsonPath形式で指定し、ローカルフィールドとの対応表を表示する
2. WHERE JIRAからデータを取得する場合 THE SYSTEM SHALL すべてのフィールドマッピングをJsonPath形式（例：$.fields.summary、$.fields.customfield_10001）で統一管理する
3. WHEN 管理者がフィールドマッピングを設定する THEN システムはJsonPath形式での入力を受け付け、構文の妥当性を検証する
4. IF 無効なJsonPath形式が入力された場合 THEN システムは構文エラーを表示し、正しい形式の例を提示する
5. WHEN 管理者がカスタムフィールドのマッピングを設定する THEN システムは値の変換ルール（日付形式、ステータス値の対応など）を設定可能にする
6. WHERE データ型が異なるフィールド間のマッピングが設定される場合 THE SYSTEM SHALL 型変換の警告を表示する
7. WHEN マッピング設定が保存される THEN システムは設定の妥当性を検証し、問題がある場合は詳細を表示する
8. WHERE JIRAプロジェクトが同期される場合 THE SYSTEM SHALL ローカルプロジェクトコードとは別にJIRA issue_keyを専用フィールドとして保持する
9. WHEN JIRAからプロジェクトを同期する THEN システムはissue_keyをプロジェクトテーブルの専用カラムに保存し、ローカルプロジェクトコードとは独立して管理する
10. WHERE システム全体でJIRAフィールドアクセスが必要な場合 THE SYSTEM SHALL 統一されたJsonPath設定を参照し、一貫性のあるデータ取得を保証する

### Requirement 6: 同期履歴とモニタリング
**User Story:** 管理者として、JIRA同期の実行履歴と詳細を確認したい。これにより、同期の問題を特定し、トラブルシューティングができる。

#### Acceptance Criteria
1. WHEN 管理者が同期履歴画面にアクセスする THEN システムは過去30日間の同期実行履歴を一覧表示する
2. WHERE 同期履歴が表示される場合 THE SYSTEM SHALL 実行日時、トリガー（自動/手動）、ステータス（同期中/同期完了/同期失敗）、処理件数を表示する
3. WHEN 管理者が特定の同期履歴をクリックする THEN システムは詳細情報（処理されたプロジェクト一覧、エラー詳細、実行されたJQLクエリ）を表示する
4. IF 同期でエラーが発生していた場合 THEN システムはエラーの原因と影響を受けたプロジェクトを特定可能な形式で表示する
5. WHEN 管理者が期間フィルターを設定する THEN システムは指定期間の同期履歴のみを表示する
6. WHEN 管理者がエクスポートボタンをクリックする THEN システムは同期履歴をCSV形式でダウンロード可能にする
7. WHERE 同期処理が実行される場合 THE SYSTEM SHALL ステータスのみ（同期中/同期完了/同期失敗）を表示し、残り時間や進捗パーセンテージは表示しない

### Requirement 7: データ競合解決
**User Story:** システムとして、JIRAとローカルデータの間で競合が発生した場合、適切に解決したい。これにより、データの一貫性を保つ。

#### Acceptance Criteria
1. IF 同じissue_keyを持つプロジェクトがJIRAとローカルの両方で更新されていた場合 THEN システムはJIRAのデータを優先（マスターとする）して更新する
2. WHEN データ競合が検出される THEN システムは競合の詳細（フィールド名、JIRA値、ローカル値、更新日時）をログに記録する
3. IF ローカルのみに存在するプロジェクトがJQLクエリに該当しなくなった場合 THEN システムはプロジェクトを「JIRA同期対象外」としてマークする
4. WHERE 重要なフィールド（プロジェクトステータス、担当者など）で競合が発生した場合 THE SYSTEM SHALL 管理者に通知を送信する
5. WHEN 管理者が競合解決ポリシーを設定する THEN システムは「常にJIRA優先」「ローカル優先」「手動確認」から選択可能にする
6. IF 手動確認が選択されている場合 THEN システムは競合を保留リストに追加し、管理者の判断を待つ

### Requirement 8: エラー処理とリトライ
**User Story:** システムとして、JIRA API通信エラーが発生した場合、適切にリトライして復旧したい。これにより、一時的な問題による同期失敗を防ぐ。

#### Acceptance Criteria
1. IF JIRA APIへの接続がタイムアウトした場合 THEN システムは30秒後に自動的にリトライする（最大3回）
2. WHEN ネットワークエラーが発生する THEN システムはエクスポネンシャルバックオフ（30秒、1分、2分）でリトライする
3. IF JIRA APIレート制限に達した場合 THEN システムはAPIレスポンスヘッダーから待機時間を取得し、その時間後にリトライする
4. WHERE 認証エラーが発生した場合 THE SYSTEM SHALL リトライせずに管理者に即座に通知する
5. WHEN 特定のプロジェクトの同期が5回連続で失敗する THEN システムはそのプロジェクトを一時的にスキップし、次回同期時に再試行する
6. IF すべてのリトライが失敗した場合 THEN システムは詳細なエラー情報をログに記録し、管理者にメール通知する

### Requirement 9: セキュリティとアクセス制御
**User Story:** 管理者として、JIRA同期機能へのアクセスを適切に制御したい。これにより、不正な設定変更や情報漏洩を防ぐ。

#### Acceptance Criteria
1. WHEN ユーザーがJIRA同期管理機能にアクセスしようとする THEN システムは管理者権限を持つユーザーのみアクセスを許可する
2. WHERE JIRA認証情報が必要な場合 THE SYSTEM SHALL 環境変数から取得し、メモリ内で一時的に保持するのみでローカルストレージには保存しない
3. WHEN システムがJIRA認証情報を使用する THEN 環境変数から読み込み、使用後は変数をクリアする
4. WHERE 認証情報が設定される場合 THE SYSTEM SHALL Kubernetes Secretから環境変数として注入される
5. IF 環境変数から認証情報が取得できない場合 THEN システムは詳細なエラーをログに記録し、認証情報の詳細は含めない
6. WHEN 管理者がJIRA同期設定を変更する THEN システムは変更内容、変更者、変更日時を監査ログに記録するが、機密情報は記録しない
7. WHERE JIRA同期ログが表示される場合 THE SYSTEM SHALL URLのみを表示し、実際の認証情報は表示しない
8. WHEN システムがシャットダウンまたは再起動する THEN メモリ内の認証情報を完全にクリアする
9. IF 不正なアクセス試行が検出された場合 THEN システムはセキュリティログに記録し、管理者に通知する

---
**STATUS**: Requirements generated
**NEXT PHASE**: After review, run `/sdd:spec-design jira-project-sync` to generate technical design