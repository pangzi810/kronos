# Requirements Document

## 概要
承認者自己管理機能は、システムユーザーが自分の承認者（上司）を確認できる参照機能です。この機能により、承認ワークフローの透明性を確保し、誰が自分の工数を承認する権限を持っているかを把握できます。承認者の設定は社員マスタからのバッチ処理により自動的に行われ、組織階層に基づいて適切な承認ルートが構築されます。

## 要件

### 要件1: 承認者一覧表示
**ユーザーストーリー:** 一般ユーザーとして、自分の現在および過去の承認者を確認したい、誰が自分の工数を承認する権限を持っているかを把握するため。

#### 受入基準
1. WHEN ユーザーが承認者管理画面を開く THEN システム SHALL 全ての承認者を一覧表示する
2. IF 承認者が複数存在する THEN システム SHALL 全ての承認者を一覧形式で表示する
3. WHERE 承認者一覧画面 システム SHALL 各承認者の氏名、メールアドレス、有効開始日、有効終了日を表示する
4. IF 承認者が存在しない THEN システム SHALL 「承認者が設定されていません」というメッセージを表示する

### 要件2: 権限とアクセス制御
**ユーザーストーリー:** システム管理者として、承認者管理機能の適切な権限制御を確保したい、セキュリティと運用ルールを守るため。

#### 受入基準
1. WHEN ユーザーがログインする THEN システム SHALL 自分の承認者のみ管理可能にする
2. WHERE 承認者候補選択画面 システム SHALL 承認権限を持つユーザーのみを選択可能にする
3. IF 権限のない操作を試みた場合 THEN システム SHALL 403エラーを返す

### 要件3: データ検証と整合性
**ユーザーストーリー:** システムとして、承認者データの整合性を保証したい、承認ワークフローの正常動作を確保するため。

#### 受入基準
1. WHEN 承認者を登録する THEN システム SHALL 有効開始日が有効終了日より前であることを検証する
2. IF 循環参照（AがBの承認者、BがAの承認者）が発生する THEN システム SHALL エラーを表示し登録を拒否する
3. WHILE 承認者データを保存する システム SHALL トランザクション処理で一貫性を保証する
4. IF データベース制約違反が発生する THEN システム SHALL 適切なエラーメッセージを表示する
5. WHEN 同一期間に複数の承認者が設定される THEN システム SHALL 全ての承認者を有効な承認関係として保持する

### 要件4: ユーザビリティ
**ユーザーストーリー:** 一般ユーザーとして、承認者管理操作の結果を明確に把握したい、操作の成否を即座に確認するため。

#### 受入基準
1. WHERE 承認者管理画面 システム SHALL 操作結果をトースト通知で即座にフィードバックする
2. WHEN エラーが発生する THEN システム SHALL 具体的な対処方法を含むエラーメッセージを表示する
3. WHILE ページ読み込み中 システム SHALL ローディングインジケーターを表示する

### 要件5: 社員マスタからの承認権限ユーザーバッチ登録
**ユーザーストーリー:** システム管理者として、社員マスタCSVから役職に基づいて承認権限を持つユーザーを一括登録したい、組織構造に基づいた権限設定を効率的に行うため。

#### 受入基準
1. WHEN 管理者が社員マスタCSVファイル（employee_master.csv）を配置する THEN システム SHALL バッチ処理でファイルを読み込む
2. WHERE CSVファイル システム SHALL メールアドレス、統括本部、本部、部、グループ、役職を含む形式を受け入れる
3. WHERE 役職 システム SHALL 一般社員、マネージャー、部長、本部長、統括本部長、それ以外の値を認識する
4. WHEN バッチ処理を実行する THEN システム SHALL 役職がマネージャー、部長、本部長、統括本部長のユーザーを承認権限対象として抽出する
5. WHEN 承認権限対象ユーザーが抽出される THEN システム SHALL 現在の承認権限テーブルと抽出結果の差分を計算する
6. WHERE 差分計算 システム SHALL 削除対象（DBに存在し承認権限対象外になった）と追加対象（新規に承認権限対象になった）を特定する
7. WHEN 削除対象が特定される THEN システム SHALL 承認権限テーブルから該当レコードを削除する
8. WHEN 追加対象が特定される THEN システム SHALL 承認権限テーブルにメールアドレスと役職を登録する
9. WHEN ユーザーが承認者を検索する THEN システム SHALL ユーザーテーブルと承認権限テーブルをメールアドレスで結合し承認権限を持つユーザーのみを表示する
10. WHEN バッチ処理が完了する THEN システム SHALL 処理結果（追加件数、削除件数、維持件数、役職別集計）をログファイルに出力する
11. WHERE バッチ処理 システム SHALL 全体を1つのトランザクションで処理し完全成功または完全失敗とする
12. IF CSVファイルのフォーマットが不正な場合 THEN システム SHALL 処理を中止しエラーを報告する

### 要件6: 組織階層に基づく初期承認者の自動登録
**ユーザーストーリー:** システム管理者として、社員マスタの所属と役職情報から組織階層に基づいた初期承認者を自動設定したい、適切な承認ルートを自動構築するため。

#### 受入基準
1. WHEN 社員マスタCSVを処理する THEN システム SHALL 所属情報から組織階層（グループ、部、本部、統括本部）を解析する
2. IF 一般社員がグループに所属している THEN システム SHALL 同グループのマネージャーを承認者として登録する
3. IF 一般社員が部に直接所属している THEN システム SHALL 同部の部長を承認者として登録する
4. IF 一般社員が本部に直接所属している THEN システム SHALL 同本部の本部長を承認者として登録する
5. IF 一般社員が統括本部に直接所属している THEN システム SHALL 同統括本部の統括本部長を承認者として登録する
6. IF マネージャーが存在する THEN システム SHALL そのグループが所属する部の部長を承認者として登録する
7. IF 部長が存在する THEN システム SHALL その部が所属する本部の本部長を承認者として登録する
8. IF 本部長が存在する THEN システム SHALL その本部が所属する統括本部の統括本部長を承認者として登録する
9. IF 該当する上位役職者が存在しない THEN システム SHALL 承認者を設定せずログに記録する
10. WHEN 初期承認者登録が実行される THEN システム SHALL システム登録フラグを設定し自動登録であることを明示する
11. WHERE 承認者登録 システム SHALL 有効開始日を現在日付、有効終了日を無期限として登録する
12. WHEN 処理が完了する THEN システム SHALL 登録結果（成功件数、スキップ件数、エラー詳細）をログファイルに出力する

---
**STATUS**: 要件生成完了
**NEXT STEP**: `/sdd:spec-design approver-self-management` を実行して設計フェーズへ進む